{{template "header" .}}
<div class="page-header">
	<h1>{{if .Sale.ID}}Edit Sale{{else}}New Sale{{end}}</h1>
</div>

{{if .Error}}
<div class="error">{{.Error}}</div>
{{end}}

<form action="{{if .Sale.ID}}/sales/{{.Sale.ID}}{{else}}/sales{{end}}" method="POST">
	<div class="form-group">
		<label for="date">Date</label>
		<input type="date" id="date" name="date" value="{{.Sale.Date}}" required>
	</div>

	<div class="form-group">
		<label>Shift</label>
		<div class="toggle-group">
			<input type="radio" id="shift-breakfast" name="shift" value="breakfast" {{if eq .Sale.Shift "breakfast"}}checked{{end}} required>
			<label for="shift-breakfast">Breakfast</label>
			<input type="radio" id="shift-lunch" name="shift" value="lunch" {{if eq .Sale.Shift "lunch"}}checked{{end}}>
			<label for="shift-lunch">Lunch</label>
			<input type="radio" id="shift-dinner" name="shift" value="dinner" {{if eq .Sale.Shift "dinner"}}checked{{end}}>
			<label for="shift-dinner">Dinner</label>
		</div>
	</div>

	<div class="form-group">
		<label for="net_sales">Net Sales</label>
		<input type="number" id="net_sales" name="net_sales" step="0.01" min="0" value="{{if .Sale.ID}}{{printf "%.2f" .Sale.NetSales}}{{end}}" required>
	</div>

	<div class="form-group">
		<label for="taxes">Taxes</label>
		<input type="number" id="taxes" name="taxes" step="0.01" min="0" value="{{if .Sale.ID}}{{printf "%.2f" .Sale.Taxes}}{{end}}" required>
	</div>

	<div class="form-group">
		<label for="credit_card">Credit Card Amount</label>
		<input type="number" id="credit_card" name="credit_card" step="0.01" min="0" value="{{if .Sale.ID}}{{printf "%.2f" .Sale.CreditCard}}{{end}}" required>
	</div>

	<div class="form-group">
		<label for="cash_receipt">Cash Amount (from receipt)</label>
		<input type="number" id="cash_receipt" name="cash_receipt" step="0.01" min="0" value="{{if .Sale.ID}}{{printf "%.2f" .Sale.CashReceipt}}{{end}}" required>
	</div>

	<div class="form-group">
		<label for="cash_on_hand">Cash On Hand (counted)</label>
		<input type="number" id="cash_on_hand" name="cash_on_hand" step="0.01" min="0" value="{{if .Sale.ID}}{{printf "%.2f" .Sale.CashOnHand}}{{end}}" required>
	</div>

	<div class="form-group">
		<label for="notes">Notes (optional)</label>
		<textarea id="notes" name="notes">{{.Sale.Notes}}</textarea>
	</div>

	<div style="display: flex; gap: 0.5rem;">
		<button type="submit" class="btn btn-primary">{{if .Sale.ID}}Update{{else}}Save{{end}}</button>
		<a href="/sales" class="btn btn-secondary">Cancel</a>
	</div>
</form>

{{if .Sale.ID}}
<form action="/sales/{{.Sale.ID}}/delete" method="POST" style="margin-top: 2rem;" onsubmit="return confirm('Delete this sale entry?')">
	<button type="submit" class="btn btn-danger">Delete This Entry</button>
</form>
{{end}}

<script>
(function() {
	const dateInput = document.getElementById('date');
	const shiftInputs = document.querySelectorAll('input[name="shift"]');
	const currentShift = '{{.Sale.Shift}}';
	const isEditing = {{if .Sale.ID}}true{{else}}false{{end}};

	function updateShiftAvailability(existingShifts) {
		shiftInputs.forEach(input => {
			const shift = input.value;
			const label = input.nextElementSibling;
			const isExisting = existingShifts.includes(shift);
			const isCurrentShift = isEditing && shift === currentShift;

			if (isExisting && !isCurrentShift) {
				input.disabled = true;
				label.classList.add('disabled');
			} else {
				input.disabled = false;
				label.classList.remove('disabled');
			}
		});
	}

	function fetchShifts(date) {
		if (!date) return;
		fetch('/api/sales/shifts?date=' + encodeURIComponent(date))
			.then(response => response.json())
			.then(data => {
				updateShiftAvailability(data.shifts || []);
			})
			.catch(() => {
				updateShiftAvailability([]);
			});
	}

	dateInput.addEventListener('change', function() {
		fetchShifts(this.value);
	});

	// Fetch on page load
	if (dateInput.value) {
		fetchShifts(dateInput.value);
	}
})();
</script>
{{template "footer" .}}
