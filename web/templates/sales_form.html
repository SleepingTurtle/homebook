{{template "header" .}}

<div class="flex items-center justify-between mb-6">
	<h1 class="text-2xl font-semibold text-gray-900">{{if .Sale.ID}}Edit Sale{{else}}New Sale{{end}}</h1>
</div>

{{if .Error}}
<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6 text-sm">{{.Error}}</div>
{{end}}

<form action="{{if .Sale.ID}}/sales/{{.Sale.ID}}{{else}}/sales{{end}}" method="POST" class="space-y-6">
	<!-- Date & Shift Row -->
	<div class="bg-white border border-gray-200 rounded-lg p-6">
		<div class="flex flex-wrap items-end gap-8">
			<div class="w-44 flex-shrink-0">
				<label for="date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
				<input type="date" id="date" name="date" value="{{.Sale.Date}}" required
					class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
			</div>
			<div class="flex-1 min-w-[300px]">
				<label class="block text-sm font-medium text-gray-700 mb-2">Shift</label>
				<div class="flex gap-3">
					<label class="shift-option flex-1 max-w-[140px] cursor-pointer">
						<input type="radio" name="shift" value="breakfast" {{if eq .Sale.Shift "breakfast"}}checked{{end}} required class="sr-only peer">
						<span class="flex flex-col items-center py-3 px-2 border-2 border-gray-200 rounded-lg bg-gray-50 transition-all peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-gray-300 hover:bg-white peer-disabled:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:bg-gray-100">
							<span class="text-xl mb-0.5">&#9788;</span>
							<span class="text-sm font-medium text-gray-700">Breakfast</span>
						</span>
					</label>
					<label class="shift-option flex-1 max-w-[140px] cursor-pointer">
						<input type="radio" name="shift" value="lunch" {{if eq .Sale.Shift "lunch"}}checked{{end}} class="sr-only peer">
						<span class="flex flex-col items-center py-3 px-2 border-2 border-gray-200 rounded-lg bg-gray-50 transition-all peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-gray-300 hover:bg-white peer-disabled:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:bg-gray-100">
							<span class="text-xl mb-0.5">&#9728;</span>
							<span class="text-sm font-medium text-gray-700">Lunch</span>
						</span>
					</label>
					<label class="shift-option flex-1 max-w-[140px] cursor-pointer">
						<input type="radio" name="shift" value="dinner" {{if eq .Sale.Shift "dinner"}}checked{{end}} class="sr-only peer">
						<span class="flex flex-col items-center py-3 px-2 border-2 border-gray-200 rounded-lg bg-gray-50 transition-all peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-gray-300 hover:bg-white peer-disabled:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:bg-gray-100">
							<span class="text-xl mb-0.5">&#9790;</span>
							<span class="text-sm font-medium text-gray-700">Dinner</span>
						</span>
					</label>
				</div>
			</div>
		</div>
	</div>

	<!-- All Money Fields in a Grid -->
	<div class="bg-white border border-gray-200 rounded-lg p-6">
		<h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-5">Sales & Payments</h3>
		<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-5">
			<div>
				<label for="net_sales" class="block text-sm font-medium text-gray-700 mb-1">Net Sales</label>
				<div class="flex">
					<span class="inline-flex items-center px-3 bg-gray-100 border border-r-0 border-gray-300 rounded-l-md text-gray-500 font-medium">$</span>
					<input type="number" id="net_sales" name="net_sales" step="0.01" min="0" value="{{if .Sale.ID}}{{printf "%.2f" .Sale.NetSales}}{{end}}" required
						class="flex-1 min-w-0 px-3 py-2 border border-gray-300 rounded-r-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
				</div>
			</div>
			<div>
				<label for="taxes" class="block text-sm font-medium text-gray-700 mb-1">Taxes</label>
				<div class="flex">
					<span class="inline-flex items-center px-3 bg-gray-100 border border-r-0 border-gray-300 rounded-l-md text-gray-500 font-medium">$</span>
					<input type="number" id="taxes" name="taxes" step="0.01" min="0" value="{{if .Sale.ID}}{{printf "%.2f" .Sale.Taxes}}{{end}}" required
						class="flex-1 min-w-0 px-3 py-2 border border-gray-300 rounded-r-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
				</div>
			</div>
			<div>
				<label for="credit_card" class="block text-sm font-medium text-gray-700 mb-1">Credit Card</label>
				<div class="flex">
					<span class="inline-flex items-center px-3 bg-gray-100 border border-r-0 border-gray-300 rounded-l-md text-gray-500 font-medium">$</span>
					<input type="number" id="credit_card" name="credit_card" step="0.01" min="0" value="{{if .Sale.ID}}{{printf "%.2f" .Sale.CreditCard}}{{end}}" required
						class="flex-1 min-w-0 px-3 py-2 border border-gray-300 rounded-r-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
				</div>
			</div>
			<div>
				<label for="cash_receipt" class="block text-sm font-medium text-gray-700 mb-1">Cash (Receipt)</label>
				<div class="flex">
					<span class="inline-flex items-center px-3 bg-gray-100 border border-r-0 border-gray-300 rounded-l-md text-gray-500 font-medium">$</span>
					<input type="number" id="cash_receipt" name="cash_receipt" step="0.01" min="0" value="{{if .Sale.ID}}{{printf "%.2f" .Sale.CashReceipt}}{{end}}" required
						class="flex-1 min-w-0 px-3 py-2 border border-gray-300 rounded-r-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
				</div>
			</div>
			<div>
				<label for="cash_on_hand" class="block text-sm font-medium text-gray-700 mb-1">Cash On Hand</label>
				<div class="flex">
					<span class="inline-flex items-center px-3 bg-gray-100 border border-r-0 border-gray-300 rounded-l-md text-gray-500 font-medium">$</span>
					<input type="number" id="cash_on_hand" name="cash_on_hand" step="0.01" min="0" value="{{if .Sale.ID}}{{printf "%.2f" .Sale.CashOnHand}}{{end}}" required
						class="flex-1 min-w-0 px-3 py-2 border border-gray-300 rounded-r-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
				</div>
			</div>
		</div>
	</div>

	<!-- Live Summary Bar -->
	<div class="flex flex-wrap items-center gap-6 lg:gap-8 bg-slate-800 rounded-lg px-6 py-4">
		<div class="flex flex-col gap-1">
			<span class="text-[11px] font-medium text-slate-400 uppercase tracking-wide">Gross Sales</span>
			<span class="text-xl font-semibold text-white font-mono" id="summary-gross">$0.00</span>
		</div>
		<div class="flex flex-col gap-1">
			<span class="text-[11px] font-medium text-slate-400 uppercase tracking-wide">Card</span>
			<span class="text-xl font-semibold text-white font-mono" id="summary-cc">$0.00</span>
		</div>
		<div class="flex flex-col gap-1">
			<span class="text-[11px] font-medium text-slate-400 uppercase tracking-wide">Cash Expected</span>
			<span class="text-xl font-semibold text-white font-mono" id="summary-cash-receipt">$0.00</span>
		</div>
		<div class="flex flex-col gap-1">
			<span class="text-[11px] font-medium text-slate-400 uppercase tracking-wide">Cash Counted</span>
			<span class="text-xl font-semibold text-white font-mono" id="summary-cash-counted">$0.00</span>
		</div>
		<div class="ml-auto flex flex-col items-end gap-1">
			<span class="text-[11px] font-medium text-slate-400 uppercase tracking-wide">Variance</span>
			<span class="text-xl font-semibold text-white font-mono" id="summary-variance">$0.00</span>
			<span class="text-[10px] font-semibold uppercase px-2 py-0.5 rounded" id="variance-badge"></span>
		</div>
	</div>

	<!-- Notes -->
	<div class="bg-white border border-gray-200 rounded-lg p-6">
		<h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-4">Notes</h3>
		<textarea id="notes" name="notes" rows="2" placeholder="Any notes about this shift (optional)..."
			class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">{{.Sale.Notes}}</textarea>
	</div>

	<!-- Actions -->
	<div class="flex flex-col-reverse sm:flex-row justify-between items-stretch sm:items-center gap-4 pt-2">
		<div>
			{{if .Sale.ID}}
			<button type="button" onclick="if(confirm('Delete this sale entry? This cannot be undone.')) document.getElementById('delete-form').submit();"
				class="px-4 py-2 bg-white text-red-600 border border-red-200 rounded-md text-sm font-medium hover:bg-red-50 hover:border-red-300 w-full sm:w-auto">
				Delete Entry
			</button>
			{{end}}
		</div>
		<div class="flex flex-col sm:flex-row gap-2">
			<a href="/sales" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md text-sm font-medium hover:bg-gray-50 text-center">Cancel</a>
			<button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700">
				{{if .Sale.ID}}Update Sale{{else}}Save Sale{{end}}
			</button>
		</div>
	</div>
</form>

{{if .Sale.ID}}
<form id="delete-form" action="/sales/{{.Sale.ID}}/delete" method="POST" class="hidden"></form>
{{end}}

<script>
(function() {
	const dateInput = document.getElementById('date');
	const shiftInputs = document.querySelectorAll('input[name="shift"]');
	const currentShift = '{{.Sale.Shift}}';
	const isEditing = {{if .Sale.ID}}true{{else}}false{{end}};

	function updateShiftAvailability(existingShifts) {
		shiftInputs.forEach(input => {
			const shift = input.value;
			const isExisting = existingShifts.includes(shift);
			const isCurrentShift = isEditing && shift === currentShift;

			if (isExisting && !isCurrentShift) {
				input.disabled = true;
			} else {
				input.disabled = false;
			}
		});
	}

	function fetchShifts(date) {
		if (!date) return;
		fetch('/api/sales/shifts?date=' + encodeURIComponent(date))
			.then(response => response.json())
			.then(data => {
				updateShiftAvailability(data.shifts || []);
			})
			.catch(() => {
				updateShiftAvailability([]);
			});
	}

	dateInput.addEventListener('change', function() {
		fetchShifts(this.value);
	});

	if (dateInput.value) {
		fetchShifts(dateInput.value);
	}

	// Live summary calculations
	const netSales = document.getElementById('net_sales');
	const taxes = document.getElementById('taxes');
	const creditCard = document.getElementById('credit_card');
	const cashReceipt = document.getElementById('cash_receipt');
	const cashOnHand = document.getElementById('cash_on_hand');

	const summaryGross = document.getElementById('summary-gross');
	const summaryCC = document.getElementById('summary-cc');
	const summaryCashReceipt = document.getElementById('summary-cash-receipt');
	const summaryCashCounted = document.getElementById('summary-cash-counted');
	const summaryVariance = document.getElementById('summary-variance');
	const varianceBadge = document.getElementById('variance-badge');

	function formatMoney(val) {
		return '$' + Math.abs(val).toFixed(2);
	}

	function updateSummary() {
		const net = parseFloat(netSales.value) || 0;
		const tax = parseFloat(taxes.value) || 0;
		const cc = parseFloat(creditCard.value) || 0;
		const cashR = parseFloat(cashReceipt.value) || 0;
		const cashH = parseFloat(cashOnHand.value) || 0;

		const gross = net + tax;
		const variance = cashH - cashR;

		summaryGross.textContent = formatMoney(gross);
		summaryCC.textContent = formatMoney(cc);
		summaryCashReceipt.textContent = formatMoney(cashR);
		summaryCashCounted.textContent = formatMoney(cashH);

		const prefix = variance >= 0 ? '+' : '-';
		summaryVariance.textContent = prefix + formatMoney(variance);

		// Reset classes
		summaryVariance.className = 'text-xl font-semibold font-mono';
		varianceBadge.className = 'text-[10px] font-semibold uppercase px-2 py-0.5 rounded';

		if (variance > 0.01) {
			summaryVariance.classList.add('text-green-400');
			varianceBadge.classList.add('bg-green-900', 'text-green-300');
			varianceBadge.textContent = 'Over';
		} else if (variance < -0.01) {
			summaryVariance.classList.add('text-red-400');
			varianceBadge.classList.add('bg-red-900', 'text-red-300');
			varianceBadge.textContent = 'Short';
		} else {
			summaryVariance.classList.add('text-slate-400');
			varianceBadge.classList.add('bg-slate-700', 'text-slate-300');
			varianceBadge.textContent = 'Balanced';
		}
	}

	[netSales, taxes, creditCard, cashReceipt, cashOnHand].forEach(input => {
		input.addEventListener('input', updateSummary);
	});

	updateSummary();
})();
</script>

{{template "footer" .}}
