{{template "header" .}}
<div class="page-header">
	<h1>{{if .Expense.ID}}Edit Expense{{else}}New Expense{{end}}</h1>
</div>

{{if .Error}}
<div class="error">{{.Error}}</div>
{{end}}

<form action="{{if .Expense.ID}}/expenses/{{.Expense.ID}}{{else}}/expenses{{end}}" method="POST" enctype="multipart/form-data">
	<div class="form-group">
		<label for="date">Date</label>
		<input type="date" id="date" name="date" value="{{.Expense.Date}}" required>
	</div>

	<div class="form-group">
		<label for="vendor_id">Vendor</label>
		<select id="vendor_id" name="vendor_id" required>
			<option value="">Select Vendor</option>
			{{range .Vendors}}
			<option value="{{.ID}}" {{if eq $.Expense.VendorID .ID}}selected{{end}}>{{.Name}}</option>
			{{end}}
		</select>
	</div>

	<div class="form-group">
		<label for="amount">Amount</label>
		<input type="number" id="amount" name="amount" step="0.01" min="0" value="{{if .Expense.ID}}{{printf "%.2f" .Expense.Amount}}{{end}}" required>
	</div>

	<div class="form-group">
		<label for="invoice_number">Invoice Number (optional)</label>
		<input type="text" id="invoice_number" name="invoice_number" value="{{.Expense.InvoiceNumber}}">
	</div>

	<div class="form-group">
		<label for="status">Status</label>
		<select id="status" name="status" required>
			<option value="not_paid" {{if or (not .Expense.ID) (eq .Expense.Status "not_paid")}}selected{{end}}>Unpaid</option>
			<option value="paid" {{if eq .Expense.Status "paid"}}selected{{end}}>Paid</option>
		</select>
	</div>

	<div class="form-group">
		<label for="payment_type">Payment Type</label>
		<select id="payment_type" name="payment_type">
			<option value="">Select</option>
			<option value="cash" {{if eq .Expense.PaymentType "cash"}}selected{{end}}>Cash</option>
			<option value="check" {{if eq .Expense.PaymentType "check"}}selected{{end}}>Check</option>
			<option value="debit" {{if eq .Expense.PaymentType "debit"}}selected{{end}}>Debit</option>
			<option value="credit" {{if eq .Expense.PaymentType "credit"}}selected{{end}}>Credit</option>
		</select>
	</div>

	<div class="form-group">
		<label for="check_number">Check Number (optional){{if .LastCheckNumber}} - Last: {{.LastCheckNumber}}{{end}}</label>
		<input type="text" id="check_number" name="check_number" value="{{.Expense.CheckNumber}}">
	</div>

	<div class="form-group">
		<label for="date_opened">Date Opened (optional)</label>
		<input type="date" id="date_opened" name="date_opened" value="{{.Expense.DateOpened}}">
	</div>

	<div class="form-group">
		<label for="due_date">Due Date (optional)</label>
		<input type="date" id="due_date" name="due_date" value="{{.Expense.DueDate}}">
	</div>

	<div class="form-group">
		<label for="date_paid">Date Paid (optional)</label>
		<input type="date" id="date_paid" name="date_paid" value="{{.Expense.DatePaid}}">
	</div>

	<div class="form-group">
		<label for="notes">Notes (optional)</label>
		<textarea id="notes" name="notes">{{.Expense.Notes}}</textarea>
	</div>

	<div class="form-group">
		<label for="receipt">Receipt (optional)</label>
		{{if .Expense.ReceiptPath}}
		<div style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
			<a href="/expenses/{{.Expense.ID}}/receipt" target="_blank" class="btn btn-secondary btn-small">View Current Receipt</a>
			<button type="button" class="btn btn-danger btn-small" onclick="deleteReceipt({{.Expense.ID}})">Remove</button>
		</div>
		<small style="color: #6b7280;">Upload a new file to replace the current receipt</small>
		{{end}}
		<input type="file" id="receipt" name="receipt" accept=".pdf,.jpg,.jpeg,.png,.gif">
	</div>

	<div style="display: flex; gap: 0.5rem;">
		<button type="submit" class="btn btn-primary">{{if .Expense.ID}}Update{{else}}Save{{end}}</button>
		<a href="/expenses" class="btn btn-secondary">Cancel</a>
	</div>
</form>

{{if .Expense.ID}}
<form action="/expenses/{{.Expense.ID}}/delete" method="POST" style="margin-top: 2rem;" onsubmit="return confirm('Delete this expense?')">
	<button type="submit" class="btn btn-danger">Delete This Expense</button>
</form>

<script>
function deleteReceipt(expenseId) {
	if (!confirm('Remove this receipt?')) return;

	fetch('/expenses/' + expenseId + '/receipt/delete', {
		method: 'POST'
	}).then(function(response) {
		if (response.ok) {
			window.location.reload();
		} else {
			alert('Failed to remove receipt');
		}
	}).catch(function(err) {
		alert('Error: ' + err.message);
	});
}
</script>
{{end}}
{{template "footer" .}}
