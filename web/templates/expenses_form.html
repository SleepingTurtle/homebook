{{template "header" .}}

<div class="flex items-center justify-between mb-6">
	<h1 class="text-2xl font-semibold text-gray-900">{{if .Expense.ID}}Edit Receipt{{else}}New Receipt{{end}}</h1>
</div>

{{if .Error}}
<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6 text-sm">{{.Error}}</div>
{{end}}

<form action="{{if .Expense.ID}}/expenses/{{.Expense.ID}}{{else}}/expenses{{end}}" method="POST" enctype="multipart/form-data">
	<div class="grid grid-cols-1 lg:grid-cols-[1fr_320px] gap-8 items-start">
		<!-- Left Column: Main Details -->
		<div class="space-y-6 order-2 lg:order-1">
			<!-- Basic Info Section -->
			<div class="bg-white border border-gray-200 rounded-lg p-5">
				<h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-4 pb-3 border-b border-gray-100">Basic Information</h3>
				<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
					<div>
						<label for="vendor_id" class="block text-sm font-medium text-gray-700 mb-1">Vendor</label>
						<select id="vendor_id" name="vendor_id" required
							class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
							<option value="">Select Vendor</option>
							{{range .Vendors}}
							<option value="{{.ID}}" {{if eq $.Expense.VendorID .ID}}selected{{end}}>{{.Name}}</option>
							{{end}}
						</select>
					</div>
					<div>
						<label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
						<div class="flex">
							<span class="inline-flex items-center px-3 bg-gray-100 border border-r-0 border-gray-300 rounded-l-md text-gray-500 font-medium">$</span>
							<input type="number" id="amount" name="amount" step="0.01" min="0" value="{{if .Expense.ID}}{{printf "%.2f" .Expense.Amount}}{{end}}" required
								class="flex-1 min-w-0 px-3 py-2 border border-gray-300 rounded-r-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
						</div>
					</div>
				</div>
				<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
					<div>
						<label for="date" class="block text-sm font-medium text-gray-700 mb-1">Receipt Date</label>
						<input type="date" id="date" name="date" value="{{.Expense.Date}}" required
							class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
					</div>
					<div>
						<label for="invoice_number" class="block text-sm font-medium text-gray-700 mb-1">Invoice Number</label>
						<input type="text" id="invoice_number" name="invoice_number" value="{{.Expense.InvoiceNumber}}" placeholder="Optional"
							class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
					</div>
				</div>
			</div>

			<!-- Payment Section -->
			<div class="bg-white border border-gray-200 rounded-lg p-5">
				<h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-4 pb-3 border-b border-gray-100">Payment Details</h3>
				<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
					<div>
						<label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
						<select id="status" name="status" required
							class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
							<option value="not_paid" {{if or (not .Expense.ID) (eq .Expense.Status "not_paid")}}selected{{end}}>Unpaid</option>
							<option value="paid" {{if eq .Expense.Status "paid"}}selected{{end}}>Paid</option>
						</select>
					</div>
					<div>
						<label for="payment_type" class="block text-sm font-medium text-gray-700 mb-1">Payment Method</label>
						<select id="payment_type" name="payment_type"
							class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
							<option value="">Not specified</option>
							<option value="cash" {{if eq .Expense.PaymentType "cash"}}selected{{end}}>Cash</option>
							<option value="check" {{if eq .Expense.PaymentType "check"}}selected{{end}}>Check</option>
							<option value="debit" {{if eq .Expense.PaymentType "debit"}}selected{{end}}>Debit Card</option>
							<option value="credit" {{if eq .Expense.PaymentType "credit"}}selected{{end}}>Credit Card</option>
						</select>
					</div>
				</div>
				<div id="check-number-group" class="{{if ne .Expense.PaymentType "check"}}hidden{{end}}">
					<label for="check_number" class="block text-sm font-medium text-gray-700 mb-1">
						Check Number
						{{if .LastCheckNumber}}<span class="font-normal text-gray-500">(Last used: {{.LastCheckNumber}})</span>{{end}}
					</label>
					<input type="text" id="check_number" name="check_number" value="{{.Expense.CheckNumber}}" placeholder="Enter check number"
						class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
				</div>
			</div>

			<!-- Dates Section -->
			<div class="bg-white border border-gray-200 rounded-lg p-5">
				<h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-4 pb-3 border-b border-gray-100">Important Dates</h3>
				<div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
					<div>
						<label for="date_opened" class="block text-sm font-medium text-gray-700 mb-1">Date Opened</label>
						<input type="date" id="date_opened" name="date_opened" value="{{.Expense.DateOpened}}"
							class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
					</div>
					<div>
						<label for="due_date" class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
						<input type="date" id="due_date" name="due_date" value="{{.Expense.DueDate}}"
							class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
					</div>
					<div>
						<label for="date_paid" class="block text-sm font-medium text-gray-700 mb-1">Date Paid</label>
						<input type="date" id="date_paid" name="date_paid" value="{{.Expense.DatePaid}}"
							class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
					</div>
				</div>
			</div>

			<!-- Notes Section -->
			<div class="bg-white border border-gray-200 rounded-lg p-5">
				<h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-4 pb-3 border-b border-gray-100">Notes</h3>
				<textarea id="notes" name="notes" rows="3" placeholder="Add any additional notes..."
					class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">{{.Expense.Notes}}</textarea>
			</div>
		</div>

		<!-- Right Column: Receipt & Actions -->
		<div class="space-y-6 order-1 lg:order-2">
			<!-- Receipt Upload Section -->
			<div class="bg-white border border-gray-200 rounded-lg p-5">
				<h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-4 pb-3 border-b border-gray-100">Receipt File</h3>
				{{if .Expense.ReceiptPath}}
				<div class="flex items-center gap-4 p-4 bg-green-50 border border-green-200 rounded-lg">
					<div class="text-green-600">
						<svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
						</svg>
					</div>
					<div class="flex-1">
						<span class="block font-medium text-green-800 mb-2">Receipt attached</span>
						<div class="flex gap-2">
							<a href="/expenses/{{.Expense.ID}}/receipt" target="_blank" class="px-3 py-1 bg-white border border-gray-300 text-gray-700 rounded text-xs font-medium hover:bg-gray-50">View</a>
							<button type="button" onclick="deleteReceipt({{.Expense.ID}})" class="px-3 py-1 bg-red-600 text-white rounded text-xs font-medium hover:bg-red-700">Remove</button>
						</div>
					</div>
				</div>
				<div class="mt-4">
					<label for="receipt" class="block text-sm text-gray-500 mb-1">Replace with new file</label>
					<input type="file" id="receipt" name="receipt" accept=".pdf,.jpg,.jpeg,.png,.gif"
						class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200">
				</div>
				{{else}}
				<div onclick="document.getElementById('receipt').click()"
					class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer transition-all hover:border-blue-500 hover:bg-blue-50 group">
					<svg class="mx-auto mb-2 text-gray-400 group-hover:text-blue-500" width="40" height="40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
					</svg>
					<span class="block font-medium text-gray-700 mb-1">Click to upload receipt</span>
					<span class="block text-xs text-gray-400">PDF, JPG, PNG up to 5MB</span>
				</div>
				<input type="file" id="receipt" name="receipt" accept=".pdf,.jpg,.jpeg,.png,.gif" class="hidden">
				{{end}}
			</div>

			<!-- Action Buttons -->
			<div class="space-y-2">
				<button type="submit" class="w-full px-4 py-2.5 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700">
					{{if .Expense.ID}}Update Receipt{{else}}Save Receipt{{end}}
				</button>
				<a href="/expenses" class="block w-full px-4 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-md text-sm font-medium hover:bg-gray-50 text-center">Cancel</a>
			</div>

			{{if .Expense.ID}}
			<div class="pt-4 border-t border-gray-200">
				<button type="button" onclick="if(confirm('Delete this receipt? This cannot be undone.')) document.getElementById('delete-form').submit();"
					class="w-full px-4 py-2 bg-white text-red-600 border border-red-200 rounded-md text-sm font-medium hover:bg-red-50 hover:border-red-300">
					Delete Receipt
				</button>
			</div>
			{{end}}
		</div>
	</div>
</form>

{{if .Expense.ID}}
<form id="delete-form" action="/expenses/{{.Expense.ID}}/delete" method="POST" class="hidden"></form>

<script>
function deleteReceipt(expenseId) {
	if (!confirm('Remove this receipt file?')) return;

	fetch('/expenses/' + expenseId + '/receipt/delete', {
		method: 'POST'
	}).then(function(response) {
		if (response.ok) {
			window.location.reload();
		} else {
			alert('Failed to remove receipt');
		}
	}).catch(function(err) {
		alert('Error: ' + err.message);
	});
}
</script>
{{end}}

<script>
document.getElementById('payment_type').addEventListener('change', function() {
	var checkGroup = document.getElementById('check-number-group');
	checkGroup.classList.toggle('hidden', this.value !== 'check');
});
</script>

{{template "footer" .}}
