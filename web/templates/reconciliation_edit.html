{{template "header" .}}

<div class="page-header">
	<h1>Bank Statement: {{.Reconciliation.StatementDateDisplay}}</h1>
	<div style="display: flex; gap: 0.5rem;">
		<form action="/bank-statements/{{.Reconciliation.ID}}/reparse" method="POST" style="margin: 0;">
			<button type="submit" class="btn btn-secondary" onclick="return confirm('Re-parse the statement? This will delete existing transactions and re-import them.')">Reparse</button>
		</form>
		<form action="/bank-statements/{{.Reconciliation.ID}}/delete" method="POST" style="margin: 0;">
			<button type="submit" class="btn btn-danger" onclick="return confirm('Delete this bank statement and all its transactions? This cannot be undone.')">Delete</button>
		</form>
		<a href="/bank-statements" class="btn btn-secondary">Back</a>
	</div>
</div>

<div class="sidebar-layout">
	<!-- Review Status Sidebar -->
	<aside class="sidebar">
		<div class="sidebar-filter">
			<h3 class="sidebar-title">Review Status</h3>
			{{if .Stats}}
			<div class="review-sidebar {{if eq .Stats.UnmatchedCount 0}}complete{{else}}pending{{end}}">
				<div class="review-stat">
					<span class="review-stat-label">Total</span>
					<span class="review-stat-value">{{.Stats.TotalTransactions}}</span>
				</div>
				<div class="review-stat">
					<span class="review-stat-label">Matched</span>
					<span class="review-stat-value" style="color: #16a34a;">{{.Stats.MatchedCount}}</span>
				</div>
				<div class="review-stat">
					<span class="review-stat-label">Unmatched</span>
					<span class="review-stat-value" style="color: #d97706;">{{.Stats.UnmatchedCount}}</span>
				</div>
				<div class="review-stat">
					<span class="review-stat-label">Ignored</span>
					<span class="review-stat-value" style="color: #6b7280;">{{.Stats.IgnoredCount}}</span>
				</div>
				<div class="review-stat">
					<span class="review-stat-label">Created</span>
					<span class="review-stat-value" style="color: #2563eb;">{{.Stats.CreatedCount}}</span>
				</div>
			</div>
			{{if and (eq .Stats.UnmatchedCount 0) (ne .Reconciliation.Status "completed")}}
			<form action="/bank-statements/{{.Reconciliation.ID}}/complete" method="POST" style="margin-top: 1rem;">
				<button type="submit" class="btn btn-success" style="width: 100%;">Mark as Completed</button>
			</form>
			{{else if eq .Reconciliation.Status "completed"}}
			<div style="margin-top: 1rem; text-align: center;">
				<span class="status status-paid">Completed</span>
			</div>
			{{end}}
			{{end}}

			<h3 class="sidebar-title" style="margin-top: 1.5rem;">Account Summary</h3>
			<div class="review-stat">
				<span class="review-stat-label">Account</span>
				<span class="review-stat-value">****{{.Reconciliation.AccountLastFour}}</span>
			</div>
			<div class="review-stat">
				<span class="review-stat-label">Deposits</span>
				<span class="review-stat-value" style="color: #16a34a;">+${{printf "%.2f" .Reconciliation.ElectronicDeposits}}</span>
			</div>
			<div class="review-stat">
				<span class="review-stat-label">Payments</span>
				<span class="review-stat-value" style="color: #dc2626;">-${{printf "%.2f" .Reconciliation.ElectronicPayments}}</span>
			</div>
			<div class="review-stat">
				<span class="review-stat-label">Checks</span>
				<span class="review-stat-value" style="color: #dc2626;">-${{printf "%.2f" .Reconciliation.ChecksPaid}}</span>
			</div>
			<div class="review-stat">
				<span class="review-stat-label">Fees</span>
				<span class="review-stat-value" style="color: #dc2626;">-${{printf "%.2f" .Reconciliation.ServiceFees}}</span>
			</div>
		</div>
	</aside>

	<main class="main-content">
{{if .Transactions}}
{{$reconID := .Reconciliation.ID}}
{{$expenses := .Expenses}}
{{$vendors := .Vendors}}

<!-- Deposits & Credits Section -->
<div class="card" style="margin-bottom: 1.5rem; border-left: 4px solid #16a34a;">
	<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
		<h3 style="margin: 0; color: #16a34a;">Deposits & Credits</h3>
		<div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
			<div style="display: flex; gap: 0.25rem;">
				<button type="button" class="btn btn-small filter-btn active" data-table="deposits" data-filter-type="type" data-filter="all">All Types</button>
				<button type="button" class="btn btn-small filter-btn" data-table="deposits" data-filter-type="type" data-filter="deposit">Deposit</button>
				<button type="button" class="btn btn-small filter-btn" data-table="deposits" data-filter-type="type" data-filter="ach">ACH</button>
				<button type="button" class="btn btn-small filter-btn" data-table="deposits" data-filter-type="type" data-filter="refund">Refund</button>
				<button type="button" class="btn btn-small filter-btn" data-table="deposits" data-filter-type="type" data-filter="credit">Credit</button>
			</div>
			<div style="display: flex; gap: 0.25rem;">
				<button type="button" class="btn btn-small status-btn active" data-table="deposits" data-filter-type="status" data-filter="all">All</button>
				<button type="button" class="btn btn-small status-btn" data-table="deposits" data-filter-type="status" data-filter="unmatched">Unmatched</button>
				<button type="button" class="btn btn-small status-btn" data-table="deposits" data-filter-type="status" data-filter="matched">Matched</button>
				<button type="button" class="btn btn-small status-btn" data-table="deposits" data-filter-type="status" data-filter="ignored">Ignored</button>
			</div>
		</div>
	</div>
	<table id="deposits-table" class="txn-table">
		<thead>
			<tr>
				<th>Date</th>
				<th>Description</th>
				<th>Type</th>
				<th class="money">Amount</th>
				<th>Status</th>
				<th class="actions">Actions</th>
			</tr>
		</thead>
		<tbody>
			{{range .Transactions}}
			{{if ge .Amount 0.0}}
			<tr data-status="{{.MatchStatus}}" data-type="{{.TransactionType}}" data-amount="{{.Amount}}">
				<td>{{.PostingDate}}</td>
				<td>
					{{.Description}}
					{{if .VendorHint}}<br><small style="color: #6b7280;">{{.VendorHint}}</small>{{end}}
				</td>
				<td>
					<form action="/bank-statements/{{$reconID}}/update-type" method="POST" style="margin: 0;">
						<input type="hidden" name="transaction_id" value="{{.ID}}">
						<select name="transaction_type" onchange="this.form.submit()" style="font-size: 0.75rem; padding: 2px 4px; border: 1px solid #d1d5db; border-radius: 4px; background: #f9fafb;">
							<option value="deposit" {{if eq .TransactionType "deposit"}}selected{{end}}>deposit</option>
							<option value="ach" {{if eq .TransactionType "ach"}}selected{{end}}>ach</option>
							<option value="refund" {{if eq .TransactionType "refund"}}selected{{end}}>refund</option>
							<option value="credit" {{if eq .TransactionType "credit"}}selected{{end}}>credit</option>
						</select>
					</form>
				</td>
				<td class="money"><span style="color: #16a34a;">+${{printf "%.2f" .Amount}}</span></td>
				<td>
					{{if eq .MatchStatus "matched"}}
						<span class="status status-paid">Matched</span>
					{{else if eq .MatchStatus "ignored"}}
						<span class="status" style="background: #e5e7eb; color: #6b7280;">Ignored</span>
					{{else}}
						<span class="status status-unpaid">Unmatched</span>
					{{end}}
				</td>
				<td class="actions">
					{{if eq .MatchStatus "unmatched"}}
						<form action="/bank-statements/{{$reconID}}/ignore" method="POST" style="display: inline; margin: 0;">
							<input type="hidden" name="transaction_id" value="{{.ID}}">
							<button type="submit" class="btn btn-secondary btn-small">Ignore</button>
						</form>
					{{else if eq .MatchStatus "ignored"}}
						<form action="/bank-statements/{{$reconID}}/unmatch" method="POST" style="display: inline; margin: 0;">
							<input type="hidden" name="transaction_id" value="{{.ID}}">
							<button type="submit" class="btn btn-secondary btn-small">Restore</button>
						</form>
					{{else}}
						<form action="/bank-statements/{{$reconID}}/unmatch" method="POST" style="display: inline; margin: 0;">
							<input type="hidden" name="transaction_id" value="{{.ID}}">
							<button type="submit" class="btn btn-secondary btn-small">Unmatch</button>
						</form>
					{{end}}
				</td>
			</tr>
			{{end}}
			{{end}}
		</tbody>
		<tfoot>
			<tr>
				<td colspan="3" style="text-align: right; font-weight: 600;">Visible Total:</td>
				<td class="money"><span id="deposits-total" style="color: #16a34a; font-weight: 600;">$0.00</span></td>
				<td colspan="2"></td>
			</tr>
		</tfoot>
	</table>
</div>

<!-- Payments & Debits Section -->
<div class="card" style="margin-bottom: 1.5rem; border-left: 4px solid #dc2626;">
	<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
		<h3 style="margin: 0; color: #dc2626;">Payments & Debits</h3>
		<div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
			<div style="display: flex; gap: 0.25rem;">
				<button type="button" class="btn btn-small filter-btn active" data-table="payments" data-filter-type="type" data-filter="all">All Types</button>
				<button type="button" class="btn btn-small filter-btn" data-table="payments" data-filter-type="type" data-filter="check">Check</button>
				<button type="button" class="btn btn-small filter-btn" data-table="payments" data-filter-type="type" data-filter="debit">Debit</button>
				<button type="button" class="btn btn-small filter-btn" data-table="payments" data-filter-type="type" data-filter="ach">ACH</button>
				<button type="button" class="btn btn-small filter-btn" data-table="payments" data-filter-type="type" data-filter="transfer">Transfer</button>
				<button type="button" class="btn btn-small filter-btn" data-table="payments" data-filter-type="type" data-filter="fee">Fee</button>
			</div>
			<div style="display: flex; gap: 0.25rem;">
				<button type="button" class="btn btn-small status-btn active" data-table="payments" data-filter-type="status" data-filter="all">All</button>
				<button type="button" class="btn btn-small status-btn" data-table="payments" data-filter-type="status" data-filter="unmatched">Unmatched</button>
				<button type="button" class="btn btn-small status-btn" data-table="payments" data-filter-type="status" data-filter="matched">Matched</button>
				<button type="button" class="btn btn-small status-btn" data-table="payments" data-filter-type="status" data-filter="created">Created</button>
				<button type="button" class="btn btn-small status-btn" data-table="payments" data-filter-type="status" data-filter="ignored">Ignored</button>
			</div>
		</div>
	</div>
	<table id="payments-table" class="txn-table">
		<thead>
			<tr>
				<th>Date</th>
				<th>Description</th>
				<th>Type</th>
				<th class="money">Amount</th>
				<th>Status</th>
				<th>Match</th>
				<th class="actions">Actions</th>
			</tr>
		</thead>
		<tbody>
			{{range .Transactions}}
			{{if lt .Amount 0.0}}
			<tr data-status="{{.MatchStatus}}" data-type="{{.TransactionType}}" data-amount="{{.Amount}}">
				<td>{{.PostingDate}}</td>
				<td>
					{{.Description}}
					{{if .CheckNumber}}<br><small style="color: #6b7280;">Check #{{.CheckNumber}}</small>{{end}}
					{{if .VendorHint}}<br><small style="color: #6b7280;">{{.VendorHint}}</small>{{end}}
				</td>
				<td>
					<form action="/bank-statements/{{$reconID}}/update-type" method="POST" style="margin: 0;">
						<input type="hidden" name="transaction_id" value="{{.ID}}">
						<select name="transaction_type" onchange="this.form.submit()" style="font-size: 0.75rem; padding: 2px 4px; border: 1px solid #d1d5db; border-radius: 4px; background: #f9fafb;">
							<option value="check" {{if eq .TransactionType "check"}}selected{{end}}>check</option>
							<option value="debit" {{if eq .TransactionType "debit"}}selected{{end}}>debit</option>
							<option value="ach" {{if eq .TransactionType "ach"}}selected{{end}}>ach</option>
							<option value="transfer" {{if eq .TransactionType "transfer"}}selected{{end}}>transfer</option>
							<option value="fee" {{if eq .TransactionType "fee"}}selected{{end}}>fee</option>
							<option value="withdrawal" {{if eq .TransactionType "withdrawal"}}selected{{end}}>withdrawal</option>
							<option value="other" {{if eq .TransactionType "other"}}selected{{end}}>other</option>
						</select>
					</form>
				</td>
				<td class="money"><span style="color: #dc2626;">${{printf "%.2f" .Amount}}</span></td>
				<td>
					{{if eq .MatchStatus "matched"}}
						<span class="status status-paid">Matched</span>
					{{else if eq .MatchStatus "ignored"}}
						<span class="status" style="background: #e5e7eb; color: #6b7280;">Ignored</span>
					{{else if eq .MatchStatus "created"}}
						<span class="status" style="background: #dbeafe; color: #2563eb;">Created</span>
					{{else}}
						<span class="status status-unpaid">Unmatched</span>
					{{end}}
				</td>
				<td>
					{{if .MatchedExpenseID}}
						<small>{{.MatchedExpenseVendor}}<br>{{.MatchedExpenseDate}}</small>
					{{else if eq .MatchStatus "ignored"}}
						<small style="color: #6b7280;">{{.Notes}}</small>
					{{else}}
						<span style="color: #9ca3af;">-</span>
					{{end}}
				</td>
				<td class="actions">
					{{if eq .MatchStatus "unmatched"}}
						<button type="button" class="btn btn-secondary btn-small" onclick="openMatchModal({{.ID}}, '{{.Description}}', {{.Amount}})">Match</button>
						<button type="button" class="btn btn-secondary btn-small" onclick="openCreateModal({{.ID}}, '{{.Description}}', {{.Amount}}, '{{.PostingDate}}')">Create Receipt</button>
						<form action="/bank-statements/{{$reconID}}/ignore" method="POST" style="display: inline; margin: 0;">
							<input type="hidden" name="transaction_id" value="{{.ID}}">
							<button type="submit" class="btn btn-secondary btn-small">Ignore</button>
						</form>
					{{else if or (eq .MatchStatus "matched") (eq .MatchStatus "created")}}
						<form action="/bank-statements/{{$reconID}}/unmatch" method="POST" style="display: inline; margin: 0;">
							<input type="hidden" name="transaction_id" value="{{.ID}}">
							<button type="submit" class="btn btn-secondary btn-small">Unmatch</button>
						</form>
					{{else if eq .MatchStatus "ignored"}}
						<form action="/bank-statements/{{$reconID}}/unmatch" method="POST" style="display: inline; margin: 0;">
							<input type="hidden" name="transaction_id" value="{{.ID}}">
							<button type="submit" class="btn btn-secondary btn-small">Restore</button>
						</form>
					{{end}}
				</td>
			</tr>
			{{end}}
			{{end}}
		</tbody>
		<tfoot>
			<tr>
				<td colspan="3" style="text-align: right; font-weight: 600;">Visible Total:</td>
				<td class="money"><span id="payments-total" style="color: #dc2626; font-weight: 600;">$0.00</span></td>
				<td colspan="3"></td>
			</tr>
		</tfoot>
	</table>
</div>

<!-- Match Modal -->
<div id="match-modal" class="modal" style="display: none;">
	<div class="modal-content">
		<h3>Match Transaction</h3>
		<p id="match-modal-desc"></p>
		<form action="/bank-statements/{{.Reconciliation.ID}}/match" method="POST">
			<input type="hidden" name="transaction_id" id="match-txn-id">
			<div class="form-group">
				<label for="expense_id">Select Receipt to Match</label>
				<select name="expense_id" id="expense_id" required>
					<option value="">-- Select Receipt --</option>
					{{range .Expenses}}
					<option value="{{.ID}}">${{printf "%.2f" .Amount}} - {{.VendorName}} ({{.Date}})</option>
					{{end}}
				</select>
			</div>
			<div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
				<button type="button" class="btn btn-secondary" onclick="closeMatchModal()">Cancel</button>
				<button type="submit" class="btn btn-primary">Match</button>
			</div>
		</form>
	</div>
</div>

<!-- Create Receipt Modal -->
<div id="create-modal" class="modal" style="display: none;">
	<div class="modal-content">
		<h3>Create Receipt from Transaction</h3>
		<p id="create-modal-desc"></p>
		<form action="/bank-statements/{{.Reconciliation.ID}}/create-expense" method="POST" enctype="multipart/form-data">
			<input type="hidden" name="transaction_id" id="create-txn-id">
			<div class="form-group">
				<label for="vendor_id">Vendor</label>
				<select name="vendor_id" id="vendor_id" required>
					<option value="">-- Select Vendor --</option>
					{{range .Vendors}}
					<option value="{{.ID}}">{{.Name}}</option>
					{{end}}
				</select>
			</div>
			<div class="form-group">
				<label for="create-receipt">Receipt (optional)</label>
				<input type="file" id="create-receipt" name="receipt" accept=".pdf,.jpg,.jpeg,.png,.gif">
			</div>
			<div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
				<button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
				<button type="submit" class="btn btn-primary">Create Receipt</button>
			</div>
		</form>
	</div>
</div>

<style>
.review-sidebar {
	padding: 0.75rem;
	border-radius: 6px;
	margin-bottom: 0.5rem;
}
.review-sidebar.pending {
	background: #fef3c7;
	border: 1px solid #f59e0b;
}
.review-sidebar.complete {
	background: #dcfce7;
	border: 1px solid #16a34a;
}
.review-stat {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 0.5rem 0;
	border-bottom: 1px solid #e5e7eb;
}
.review-stat:last-child {
	border-bottom: none;
}
.review-stat-label {
	font-size: 0.875rem;
	color: #6b7280;
}
.review-stat-value {
	font-weight: 600;
	font-size: 1rem;
}
.modal {
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background: rgba(0,0,0,0.5);
	display: flex;
	align-items: center;
	justify-content: center;
	z-index: 1000;
}
.modal-content {
	background: white;
	padding: 1.5rem;
	border-radius: 8px;
	min-width: 400px;
	max-width: 90%;
}
.modal-content h3 {
	margin-top: 0;
}
.filter-btn, .status-btn {
	background: #e5e7eb;
	color: #374151;
	border: none;
}
.filter-btn:hover, .status-btn:hover {
	background: #d1d5db;
}
.filter-btn.active {
	background: #3b82f6;
	color: white;
}
.status-btn.active {
	background: #6b7280;
	color: white;
}
.txn-table {
	margin-bottom: 0;
}
</style>

<script>
function openMatchModal(txnId, desc, amount) {
	document.getElementById('match-txn-id').value = txnId;
	document.getElementById('match-modal-desc').textContent = desc + ' ($' + Math.abs(amount).toFixed(2) + ')';
	document.getElementById('match-modal').style.display = 'flex';
}

function closeMatchModal() {
	document.getElementById('match-modal').style.display = 'none';
}

function openCreateModal(txnId, desc, amount, date) {
	document.getElementById('create-txn-id').value = txnId;
	document.getElementById('create-modal-desc').textContent = desc + ' ($' + Math.abs(amount).toFixed(2) + ') - ' + date;
	document.getElementById('create-modal').style.display = 'flex';
}

function closeCreateModal() {
	document.getElementById('create-modal').style.display = 'none';
}

// Close modal on background click
document.getElementById('match-modal').addEventListener('click', function(e) {
	if (e.target === this) closeMatchModal();
});
document.getElementById('create-modal').addEventListener('click', function(e) {
	if (e.target === this) closeCreateModal();
});

// Track active filters per table
var activeFilters = {
	deposits: { type: 'all', status: 'all' },
	payments: { type: 'all', status: 'all' }
};

function applyFilters(tableName) {
	var table = document.getElementById(tableName + '-table');
	var typeFilter = activeFilters[tableName].type;
	var statusFilter = activeFilters[tableName].status;
	var total = 0;
	var count = 0;

	table.querySelectorAll('tbody tr').forEach(function(row) {
		var typeMatch = typeFilter === 'all' || row.dataset.type === typeFilter;
		var statusMatch = statusFilter === 'all' || row.dataset.status === statusFilter;
		var visible = typeMatch && statusMatch;
		row.style.display = visible ? '' : 'none';

		if (visible) {
			var amount = parseFloat(row.dataset.amount) || 0;
			total += amount;
			count++;
		}
	});

	// Update the total display
	var totalEl = document.getElementById(tableName + '-total');
	if (totalEl) {
		var absTotal = Math.abs(total);
		var formatted = absTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
		var prefix = tableName === 'deposits' ? '+$' : '$';
		totalEl.textContent = prefix + formatted + ' (' + count + ')';
	}
}

// Type filter buttons
document.querySelectorAll('.filter-btn').forEach(function(btn) {
	btn.addEventListener('click', function() {
		var tableName = this.dataset.table;
		var filter = this.dataset.filter;

		// Update active button in this group
		document.querySelectorAll('.filter-btn[data-table="' + tableName + '"]').forEach(function(b) {
			b.classList.remove('active');
		});
		this.classList.add('active');

		activeFilters[tableName].type = filter;
		applyFilters(tableName);
	});
});

// Status filter buttons
document.querySelectorAll('.status-btn').forEach(function(btn) {
	btn.addEventListener('click', function() {
		var tableName = this.dataset.table;
		var filter = this.dataset.filter;

		// Update active button in this group
		document.querySelectorAll('.status-btn[data-table="' + tableName + '"]').forEach(function(b) {
			b.classList.remove('active');
		});
		this.classList.add('active');

		activeFilters[tableName].status = filter;
		applyFilters(tableName);
	});
});

// Initialize totals on page load
applyFilters('deposits');
applyFilters('payments');
</script>
{{else}}
<p class="empty-state">No transactions found for this reconciliation.</p>
{{end}}
	</main>
</div>

{{template "footer" .}}
