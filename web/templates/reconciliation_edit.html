{{template "header" .}}

<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
	<h1 class="text-2xl font-semibold text-gray-900">Bank Statement: {{.Reconciliation.StatementDateDisplay}}</h1>
	<div class="flex gap-2">
		<form action="/bank-statements/{{.Reconciliation.ID}}/reparse" method="POST" class="m-0">
			<button type="submit" class="px-3 py-2 bg-white border border-gray-300 text-gray-700 rounded-md text-sm font-medium hover:bg-gray-50" onclick="return confirm('Re-parse the statement? This will delete existing transactions and re-import them.')">Reparse</button>
		</form>
		<form action="/bank-statements/{{.Reconciliation.ID}}/delete" method="POST" class="m-0">
			<button type="submit" class="px-3 py-2 bg-white border border-red-300 text-red-600 rounded-md text-sm font-medium hover:bg-red-50" onclick="return confirm('Delete this bank statement and all its transactions? This cannot be undone.')">Delete</button>
		</form>
		<a href="/bank-statements" class="px-3 py-2 bg-white border border-gray-300 text-gray-700 rounded-md text-sm font-medium hover:bg-gray-50">Back</a>
	</div>
</div>

<div class="flex flex-col lg:flex-row gap-6">
	<!-- Review Status Sidebar -->
	<aside class="lg:w-64 flex-shrink-0">
		<div class="bg-white border border-gray-200 rounded-lg p-4 sticky top-20">
			<h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">Review Status</h3>
			{{if .Stats}}
			<div class="p-3 rounded-md mb-4 {{if eq .Stats.UnmatchedCount 0}}bg-green-50 border border-green-200{{else}}bg-amber-50 border border-amber-200{{end}}">
				<div class="flex justify-between items-center py-2 border-b border-gray-200">
					<span class="text-sm text-gray-500">Total</span>
					<span class="font-semibold">{{.Stats.TotalTransactions}}</span>
				</div>
				<div class="flex justify-between items-center py-2 border-b border-gray-200">
					<span class="text-sm text-gray-500">Matched</span>
					<span class="font-semibold text-green-600">{{.Stats.MatchedCount}}</span>
				</div>
				<div class="flex justify-between items-center py-2 border-b border-gray-200">
					<span class="text-sm text-gray-500">Unmatched</span>
					<span class="font-semibold text-amber-600">{{.Stats.UnmatchedCount}}</span>
				</div>
				<div class="flex justify-between items-center py-2 border-b border-gray-200">
					<span class="text-sm text-gray-500">Ignored</span>
					<span class="font-semibold text-gray-500">{{.Stats.IgnoredCount}}</span>
				</div>
				<div class="flex justify-between items-center py-2">
					<span class="text-sm text-gray-500">Created</span>
					<span class="font-semibold text-blue-600">{{.Stats.CreatedCount}}</span>
				</div>
			</div>
			{{if and (eq .Stats.UnmatchedCount 0) (ne .Reconciliation.Status "completed")}}
			<form action="/bank-statements/{{.Reconciliation.ID}}/complete" method="POST">
				<button type="submit" class="w-full px-4 py-2 bg-green-600 text-white rounded-md text-sm font-medium hover:bg-green-700">Mark as Completed</button>
			</form>
			{{else if eq .Reconciliation.Status "completed"}}
			<div class="text-center">
				<span class="inline-flex px-3 py-1 text-sm font-medium rounded-full bg-green-100 text-green-800">Completed</span>
			</div>
			{{end}}
			{{end}}

			<h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mt-6 mb-3">Account Summary</h3>
			<div class="space-y-2">
				<div class="flex justify-between items-center py-2 border-b border-gray-200">
					<span class="text-sm text-gray-500">Account</span>
					<span class="font-semibold">****{{.Reconciliation.AccountLastFour}}</span>
				</div>
				<div class="flex justify-between items-center py-2 border-b border-gray-200">
					<span class="text-sm text-gray-500">Deposits</span>
					<span class="font-semibold text-green-600">+${{printf "%.2f" .Reconciliation.ElectronicDeposits}}</span>
				</div>
				<div class="flex justify-between items-center py-2 border-b border-gray-200">
					<span class="text-sm text-gray-500">Payments</span>
					<span class="font-semibold text-red-600">-${{printf "%.2f" .Reconciliation.ElectronicPayments}}</span>
				</div>
				<div class="flex justify-between items-center py-2 border-b border-gray-200">
					<span class="text-sm text-gray-500">Checks</span>
					<span class="font-semibold text-red-600">-${{printf "%.2f" .Reconciliation.ChecksPaid}}</span>
				</div>
				<div class="flex justify-between items-center py-2">
					<span class="text-sm text-gray-500">Fees</span>
					<span class="font-semibold text-red-600">-${{printf "%.2f" .Reconciliation.ServiceFees}}</span>
				</div>
			</div>
		</div>
	</aside>

	<main class="flex-1 min-w-0">
{{if .Transactions}}
{{$reconID := .Reconciliation.ID}}
{{$expenses := .Expenses}}
{{$vendors := .Vendors}}

<!-- Deposits & Credits Section -->
<div class="bg-white border border-gray-200 rounded-lg p-4 mb-6 border-l-4 border-l-green-500">
	<div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-4">
		<h3 class="text-lg font-semibold text-green-600">Deposits & Credits</h3>
		<div class="flex gap-2 flex-wrap">
			<div class="flex gap-1">
				<button type="button" class="px-2 py-1 text-xs font-medium rounded bg-blue-500 text-white filter-btn active" data-table="deposits" data-filter-type="type" data-filter="all">All Types</button>
				<button type="button" class="px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 filter-btn" data-table="deposits" data-filter-type="type" data-filter="deposit">Deposit</button>
				<button type="button" class="px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 filter-btn" data-table="deposits" data-filter-type="type" data-filter="ach">ACH</button>
				<button type="button" class="px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 filter-btn" data-table="deposits" data-filter-type="type" data-filter="refund">Refund</button>
				<button type="button" class="px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 filter-btn" data-table="deposits" data-filter-type="type" data-filter="credit">Credit</button>
			</div>
			<div class="flex gap-1">
				<button type="button" class="px-2 py-1 text-xs font-medium rounded bg-gray-500 text-white status-btn active" data-table="deposits" data-filter-type="status" data-filter="all">All</button>
				<button type="button" class="px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 status-btn" data-table="deposits" data-filter-type="status" data-filter="unmatched">Unmatched</button>
				<button type="button" class="px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 status-btn" data-table="deposits" data-filter-type="status" data-filter="matched">Matched</button>
				<button type="button" class="px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 status-btn" data-table="deposits" data-filter-type="status" data-filter="ignored">Ignored</button>
			</div>
		</div>
	</div>
	<div class="overflow-x-auto">
		<table id="deposits-table" class="w-full text-sm">
			<thead>
				<tr class="border-b border-gray-200 bg-gray-50 text-gray-500 text-xs uppercase tracking-wide">
					<th class="text-left py-2 px-3 font-medium">Date</th>
					<th class="text-left py-2 px-3 font-medium">Description</th>
					<th class="text-left py-2 px-3 font-medium">Type</th>
					<th class="text-right py-2 px-3 font-medium">Amount</th>
					<th class="text-center py-2 px-3 font-medium">Status</th>
					<th class="py-2 px-3"></th>
				</tr>
			</thead>
			<tbody class="divide-y divide-gray-100">
				{{range .Transactions}}
				{{if ge .Amount 0.0}}
				<tr class="hover:bg-gray-50" data-status="{{.MatchStatus}}" data-type="{{.TransactionType}}" data-amount="{{.Amount}}">
					<td class="py-2 px-3 text-gray-900">{{.PostingDate}}</td>
					<td class="py-2 px-3">
						<span class="text-gray-900">{{.Description}}</span>
						{{if .VendorHint}}<br><span class="text-xs text-gray-500">{{.VendorHint}}</span>{{end}}
					</td>
					<td class="py-2 px-3">
						<form action="/bank-statements/{{$reconID}}/update-type" method="POST" class="m-0">
							<input type="hidden" name="transaction_id" value="{{.ID}}">
							<select name="transaction_type" onchange="this.form.submit()" class="text-xs px-1 py-0.5 border border-gray-300 rounded bg-gray-50">
								<option value="deposit" {{if eq .TransactionType "deposit"}}selected{{end}}>deposit</option>
								<option value="ach" {{if eq .TransactionType "ach"}}selected{{end}}>ach</option>
								<option value="refund" {{if eq .TransactionType "refund"}}selected{{end}}>refund</option>
								<option value="credit" {{if eq .TransactionType "credit"}}selected{{end}}>credit</option>
							</select>
						</form>
					</td>
					<td class="py-2 px-3 text-right">
						<span class="text-green-600 font-medium">+${{printf "%.2f" .Amount}}</span>
					</td>
					<td class="py-2 px-3 text-center">
						{{if eq .MatchStatus "matched"}}
						<span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full bg-green-100 text-green-800">Matched</span>
						{{else if eq .MatchStatus "ignored"}}
						<span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full bg-gray-100 text-gray-600">Ignored</span>
						{{else}}
						<span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">Unmatched</span>
						{{end}}
					</td>
					<td class="py-2 px-3 text-right">
						{{if eq .MatchStatus "unmatched"}}
						<form action="/bank-statements/{{$reconID}}/ignore" method="POST" class="inline m-0">
							<input type="hidden" name="transaction_id" value="{{.ID}}">
							<button type="submit" class="px-2 py-1 bg-white border border-gray-300 text-gray-700 rounded text-xs font-medium hover:bg-gray-50">Ignore</button>
						</form>
						{{else if eq .MatchStatus "ignored"}}
						<form action="/bank-statements/{{$reconID}}/unmatch" method="POST" class="inline m-0">
							<input type="hidden" name="transaction_id" value="{{.ID}}">
							<button type="submit" class="px-2 py-1 bg-white border border-gray-300 text-gray-700 rounded text-xs font-medium hover:bg-gray-50">Restore</button>
						</form>
						{{else}}
						<form action="/bank-statements/{{$reconID}}/unmatch" method="POST" class="inline m-0">
							<input type="hidden" name="transaction_id" value="{{.ID}}">
							<button type="submit" class="px-2 py-1 bg-white border border-gray-300 text-gray-700 rounded text-xs font-medium hover:bg-gray-50">Unmatch</button>
						</form>
						{{end}}
					</td>
				</tr>
				{{end}}
				{{end}}
			</tbody>
			<tfoot>
				<tr class="bg-gray-50 border-t border-gray-200">
					<td colspan="3" class="py-2 px-3 text-right font-semibold text-gray-700">Visible Total:</td>
					<td class="py-2 px-3 text-right"><span id="deposits-total" class="text-green-600 font-semibold">$0.00</span></td>
					<td colspan="2"></td>
				</tr>
			</tfoot>
		</table>
	</div>
</div>

<!-- Payments & Debits Section -->
<div class="bg-white border border-gray-200 rounded-lg p-4 mb-6 border-l-4 border-l-red-500">
	<div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-4">
		<h3 class="text-lg font-semibold text-red-600">Payments & Debits</h3>
		<div class="flex gap-2 flex-wrap">
			<div class="flex gap-1">
				<button type="button" class="px-2 py-1 text-xs font-medium rounded bg-blue-500 text-white filter-btn active" data-table="payments" data-filter-type="type" data-filter="all">All Types</button>
				<button type="button" class="px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 filter-btn" data-table="payments" data-filter-type="type" data-filter="check">Check</button>
				<button type="button" class="px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 filter-btn" data-table="payments" data-filter-type="type" data-filter="debit">Debit</button>
				<button type="button" class="px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 filter-btn" data-table="payments" data-filter-type="type" data-filter="ach">ACH</button>
				<button type="button" class="px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 filter-btn" data-table="payments" data-filter-type="type" data-filter="transfer">Transfer</button>
				<button type="button" class="px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 filter-btn" data-table="payments" data-filter-type="type" data-filter="fee">Fee</button>
			</div>
			<div class="flex gap-1">
				<button type="button" class="px-2 py-1 text-xs font-medium rounded bg-gray-500 text-white status-btn active" data-table="payments" data-filter-type="status" data-filter="all">All</button>
				<button type="button" class="px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 status-btn" data-table="payments" data-filter-type="status" data-filter="unmatched">Unmatched</button>
				<button type="button" class="px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 status-btn" data-table="payments" data-filter-type="status" data-filter="matched">Matched</button>
				<button type="button" class="px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 status-btn" data-table="payments" data-filter-type="status" data-filter="created">Created</button>
				<button type="button" class="px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700 hover:bg-gray-300 status-btn" data-table="payments" data-filter-type="status" data-filter="ignored">Ignored</button>
			</div>
		</div>
	</div>
	<div class="overflow-x-auto">
		<table id="payments-table" class="w-full text-sm">
			<thead>
				<tr class="border-b border-gray-200 bg-gray-50 text-gray-500 text-xs uppercase tracking-wide">
					<th class="text-left py-2 px-3 font-medium">Date</th>
					<th class="text-left py-2 px-3 font-medium">Description</th>
					<th class="text-left py-2 px-3 font-medium">Type</th>
					<th class="text-right py-2 px-3 font-medium">Amount</th>
					<th class="text-center py-2 px-3 font-medium">Status</th>
					<th class="text-left py-2 px-3 font-medium">Match</th>
					<th class="py-2 px-3"></th>
				</tr>
			</thead>
			<tbody class="divide-y divide-gray-100">
				{{range .Transactions}}
				{{if lt .Amount 0.0}}
				<tr class="hover:bg-gray-50" data-status="{{.MatchStatus}}" data-type="{{.TransactionType}}" data-amount="{{.Amount}}">
					<td class="py-2 px-3 text-gray-900">{{.PostingDate}}</td>
					<td class="py-2 px-3">
						<span class="text-gray-900">{{.Description}}</span>
						{{if .CheckNumber}}<br><span class="text-xs text-gray-500">Check #{{.CheckNumber}}</span>{{end}}
						{{if .VendorHint}}<br><span class="text-xs text-gray-500">{{.VendorHint}}</span>{{end}}
					</td>
					<td class="py-2 px-3">
						<form action="/bank-statements/{{$reconID}}/update-type" method="POST" class="m-0">
							<input type="hidden" name="transaction_id" value="{{.ID}}">
							<select name="transaction_type" onchange="this.form.submit()" class="text-xs px-1 py-0.5 border border-gray-300 rounded bg-gray-50">
								<option value="check" {{if eq .TransactionType "check"}}selected{{end}}>check</option>
								<option value="debit" {{if eq .TransactionType "debit"}}selected{{end}}>debit</option>
								<option value="ach" {{if eq .TransactionType "ach"}}selected{{end}}>ach</option>
								<option value="transfer" {{if eq .TransactionType "transfer"}}selected{{end}}>transfer</option>
								<option value="fee" {{if eq .TransactionType "fee"}}selected{{end}}>fee</option>
								<option value="withdrawal" {{if eq .TransactionType "withdrawal"}}selected{{end}}>withdrawal</option>
								<option value="other" {{if eq .TransactionType "other"}}selected{{end}}>other</option>
							</select>
						</form>
					</td>
					<td class="py-2 px-3 text-right">
						<span class="text-red-600 font-medium">${{printf "%.2f" .Amount}}</span>
					</td>
					<td class="py-2 px-3 text-center">
						{{if eq .MatchStatus "matched"}}
						<span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full bg-green-100 text-green-800">Matched</span>
						{{else if eq .MatchStatus "ignored"}}
						<span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full bg-gray-100 text-gray-600">Ignored</span>
						{{else if eq .MatchStatus "created"}}
						<span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full bg-blue-100 text-blue-800">Created</span>
						{{else}}
						<span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">Unmatched</span>
						{{end}}
					</td>
					<td class="py-2 px-3">
						{{if .MatchedExpenseID}}
						<span class="text-xs text-gray-600">{{.MatchedExpenseVendor}}<br>{{.MatchedExpenseDate}}</span>
						{{else if eq .MatchStatus "ignored"}}
						<span class="text-xs text-gray-500">{{.Notes}}</span>
						{{else}}
						<span class="text-gray-400">-</span>
						{{end}}
					</td>
					<td class="py-2 px-3 text-right">
						<div class="flex justify-end gap-1 flex-wrap">
							{{if eq .MatchStatus "unmatched"}}
							<button type="button" class="px-2 py-1 bg-white border border-gray-300 text-gray-700 rounded text-xs font-medium hover:bg-gray-50" onclick="openMatchModal({{.ID}}, '{{.Description}}', {{.Amount}})">Match</button>
							<button type="button" class="px-2 py-1 bg-white border border-gray-300 text-gray-700 rounded text-xs font-medium hover:bg-gray-50" onclick="openCreateModal({{.ID}}, '{{.Description}}', {{.Amount}}, '{{.PostingDate}}')">Create</button>
							<form action="/bank-statements/{{$reconID}}/ignore" method="POST" class="inline m-0">
								<input type="hidden" name="transaction_id" value="{{.ID}}">
								<button type="submit" class="px-2 py-1 bg-white border border-gray-300 text-gray-700 rounded text-xs font-medium hover:bg-gray-50">Ignore</button>
							</form>
							{{else if or (eq .MatchStatus "matched") (eq .MatchStatus "created")}}
							<form action="/bank-statements/{{$reconID}}/unmatch" method="POST" class="inline m-0">
								<input type="hidden" name="transaction_id" value="{{.ID}}">
								<button type="submit" class="px-2 py-1 bg-white border border-gray-300 text-gray-700 rounded text-xs font-medium hover:bg-gray-50">Unmatch</button>
							</form>
							{{else if eq .MatchStatus "ignored"}}
							<form action="/bank-statements/{{$reconID}}/unmatch" method="POST" class="inline m-0">
								<input type="hidden" name="transaction_id" value="{{.ID}}">
								<button type="submit" class="px-2 py-1 bg-white border border-gray-300 text-gray-700 rounded text-xs font-medium hover:bg-gray-50">Restore</button>
							</form>
							{{end}}
						</div>
					</td>
				</tr>
				{{end}}
				{{end}}
			</tbody>
			<tfoot>
				<tr class="bg-gray-50 border-t border-gray-200">
					<td colspan="3" class="py-2 px-3 text-right font-semibold text-gray-700">Visible Total:</td>
					<td class="py-2 px-3 text-right"><span id="payments-total" class="text-red-600 font-semibold">$0.00</span></td>
					<td colspan="3"></td>
				</tr>
			</tfoot>
		</table>
	</div>
</div>

<!-- Match Modal -->
<div id="match-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
	<div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
		<h3 class="text-lg font-semibold text-gray-900 mb-2">Match Transaction</h3>
		<p id="match-modal-desc" class="text-sm text-gray-600 mb-4"></p>
		<form action="/bank-statements/{{.Reconciliation.ID}}/match" method="POST">
			<input type="hidden" name="transaction_id" id="match-txn-id">
			<div class="mb-4">
				<label for="expense_id" class="block text-sm font-medium text-gray-700 mb-1">Select Receipt to Match</label>
				<select name="expense_id" id="expense_id" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
					<option value="">-- Select Receipt --</option>
					{{range .Expenses}}
					<option value="{{.ID}}">${{printf "%.2f" .Amount}} - {{.VendorName}} ({{.Date}})</option>
					{{end}}
				</select>
			</div>
			<div class="flex gap-2 justify-end">
				<button type="button" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md text-sm font-medium hover:bg-gray-50" onclick="closeMatchModal()">Cancel</button>
				<button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700">Match</button>
			</div>
		</form>
	</div>
</div>

<!-- Create Receipt Modal -->
<div id="create-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
	<div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
		<h3 class="text-lg font-semibold text-gray-900 mb-2">Create Receipt from Transaction</h3>
		<p id="create-modal-desc" class="text-sm text-gray-600 mb-4"></p>
		<form action="/bank-statements/{{.Reconciliation.ID}}/create-expense" method="POST" enctype="multipart/form-data">
			<input type="hidden" name="transaction_id" id="create-txn-id">
			<div class="mb-4">
				<label for="vendor_id" class="block text-sm font-medium text-gray-700 mb-1">Vendor</label>
				<select name="vendor_id" id="vendor_id" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
					<option value="">-- Select Vendor --</option>
					{{range .Vendors}}
					<option value="{{.ID}}">{{.Name}}</option>
					{{end}}
				</select>
			</div>
			<div class="mb-4">
				<label for="create-receipt" class="block text-sm font-medium text-gray-700 mb-1">Receipt <span class="font-normal text-gray-400">(optional)</span></label>
				<input type="file" id="create-receipt" name="receipt" accept=".pdf,.jpg,.jpeg,.png,.gif"
					class="w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
			</div>
			<div class="flex gap-2 justify-end">
				<button type="button" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md text-sm font-medium hover:bg-gray-50" onclick="closeCreateModal()">Cancel</button>
				<button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700">Create Receipt</button>
			</div>
		</form>
	</div>
</div>

<script>
function openMatchModal(txnId, desc, amount) {
	document.getElementById('match-txn-id').value = txnId;
	document.getElementById('match-modal-desc').textContent = desc + ' ($' + Math.abs(amount).toFixed(2) + ')';
	document.getElementById('match-modal').classList.remove('hidden');
}

function closeMatchModal() {
	document.getElementById('match-modal').classList.add('hidden');
}

function openCreateModal(txnId, desc, amount, date) {
	document.getElementById('create-txn-id').value = txnId;
	document.getElementById('create-modal-desc').textContent = desc + ' ($' + Math.abs(amount).toFixed(2) + ') - ' + date;
	document.getElementById('create-modal').classList.remove('hidden');
}

function closeCreateModal() {
	document.getElementById('create-modal').classList.add('hidden');
}

// Close modal on background click
document.getElementById('match-modal').addEventListener('click', function(e) {
	if (e.target === this) closeMatchModal();
});
document.getElementById('create-modal').addEventListener('click', function(e) {
	if (e.target === this) closeCreateModal();
});

// Track active filters per table
var activeFilters = {
	deposits: { type: 'all', status: 'all' },
	payments: { type: 'all', status: 'all' }
};

function applyFilters(tableName) {
	var table = document.getElementById(tableName + '-table');
	var typeFilter = activeFilters[tableName].type;
	var statusFilter = activeFilters[tableName].status;
	var total = 0;
	var count = 0;

	table.querySelectorAll('tbody tr').forEach(function(row) {
		var typeMatch = typeFilter === 'all' || row.dataset.type === typeFilter;
		var statusMatch = statusFilter === 'all' || row.dataset.status === statusFilter;
		var visible = typeMatch && statusMatch;
		row.style.display = visible ? '' : 'none';

		if (visible) {
			var amount = parseFloat(row.dataset.amount) || 0;
			total += amount;
			count++;
		}
	});

	// Update the total display
	var totalEl = document.getElementById(tableName + '-total');
	if (totalEl) {
		var absTotal = Math.abs(total);
		var formatted = absTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
		var prefix = tableName === 'deposits' ? '+$' : '$';
		totalEl.textContent = prefix + formatted + ' (' + count + ')';
	}
}

// Type filter buttons
document.querySelectorAll('.filter-btn').forEach(function(btn) {
	btn.addEventListener('click', function() {
		var tableName = this.dataset.table;
		var filter = this.dataset.filter;

		// Update active button in this group
		document.querySelectorAll('.filter-btn[data-table="' + tableName + '"]').forEach(function(b) {
			b.classList.remove('active', 'bg-blue-500', 'text-white');
			b.classList.add('bg-gray-200', 'text-gray-700');
		});
		this.classList.add('active', 'bg-blue-500', 'text-white');
		this.classList.remove('bg-gray-200', 'text-gray-700');

		activeFilters[tableName].type = filter;
		applyFilters(tableName);
	});
});

// Status filter buttons
document.querySelectorAll('.status-btn').forEach(function(btn) {
	btn.addEventListener('click', function() {
		var tableName = this.dataset.table;
		var filter = this.dataset.filter;

		// Update active button in this group
		document.querySelectorAll('.status-btn[data-table="' + tableName + '"]').forEach(function(b) {
			b.classList.remove('active', 'bg-gray-500', 'text-white');
			b.classList.add('bg-gray-200', 'text-gray-700');
		});
		this.classList.add('active', 'bg-gray-500', 'text-white');
		this.classList.remove('bg-gray-200', 'text-gray-700');

		activeFilters[tableName].status = filter;
		applyFilters(tableName);
	});
});

// Initialize totals on page load
applyFilters('deposits');
applyFilters('payments');
</script>
{{else}}
<div class="bg-white border border-gray-200 rounded-lg px-6 py-12 text-center">
	<p class="text-gray-500">No transactions found for this reconciliation.</p>
</div>
{{end}}
	</main>
</div>

{{template "footer" .}}
