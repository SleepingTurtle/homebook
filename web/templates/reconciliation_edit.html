{{template "header" .}}
<div class="page-header">
	<h1>Review Reconciliation: {{.Reconciliation.StatementDateDisplay}}</h1>
	<div style="display: flex; gap: 0.5rem;">
		{{if and .Stats (eq .Stats.UnmatchedCount 0)}}
		<form action="/bank-statements/{{.Reconciliation.ID}}/complete" method="POST" style="margin: 0;">
			<button type="submit" class="btn btn-success">Mark as Completed</button>
		</form>
		{{end}}
		<form action="/bank-statements/{{.Reconciliation.ID}}/reparse" method="POST" style="margin: 0;">
			<button type="submit" class="btn btn-secondary" onclick="return confirm('Re-parse the statement? This will delete existing transactions and re-import them.')">Reparse Statement</button>
		</form>
		<a href="/bank-statements/{{.Reconciliation.ID}}" class="btn btn-secondary">View Details</a>
		<a href="/bank-statements" class="btn btn-secondary">Back</a>
	</div>
</div>

<div class="card" style="margin-bottom: 1.5rem;">
	<div style="display: flex; flex-wrap: wrap; gap: 2rem;">
		<div>
			<div style="color: #6b7280; font-size: 0.875rem;">Account</div>
			<div style="font-size: 1.25rem; font-weight: 600;">****{{.Reconciliation.AccountLastFour}}</div>
		</div>
		<div>
			<div style="color: #6b7280; font-size: 0.875rem;">Starting Balance</div>
			<div style="font-size: 1.25rem; font-weight: 600;">${{printf "%.2f" .Reconciliation.StartingBalance}}</div>
		</div>
		<div>
			<div style="color: #6b7280; font-size: 0.875rem;">Ending Balance</div>
			<div style="font-size: 1.25rem; font-weight: 600;">${{printf "%.2f" .Reconciliation.EndingBalance}}</div>
		</div>
		<div>
			<div style="color: #6b7280; font-size: 0.875rem;">Status</div>
			<div style="font-size: 1.25rem;">
				{{if eq .Reconciliation.Status "completed"}}
					<span class="status status-paid">Completed</span>
				{{else if eq .Reconciliation.Status "parsed"}}
					<span class="status status-unpaid">Ready to Review</span>
				{{else}}
					<span class="status">{{.Reconciliation.Status}}</span>
				{{end}}
			</div>
		</div>
	</div>
</div>

{{if .Stats}}
<div class="card" style="margin-bottom: 1.5rem;">
	<h3 style="margin-top: 0; margin-bottom: 1rem;">Matching Summary</h3>
	<div style="display: flex; flex-wrap: wrap; gap: 1.5rem;">
		<div style="text-align: center; padding: 0.75rem 1.5rem; background: #f3f4f6; border-radius: 8px;">
			<div style="font-size: 1.5rem; font-weight: 700;">{{.Stats.TotalTransactions}}</div>
			<div style="color: #6b7280; font-size: 0.875rem;">Total Transactions</div>
		</div>
		<div style="text-align: center; padding: 0.75rem 1.5rem; background: #dcfce7; border-radius: 8px;">
			<div style="font-size: 1.5rem; font-weight: 700; color: #16a34a;">{{.Stats.MatchedCount}}</div>
			<div style="color: #6b7280; font-size: 0.875rem;">Matched</div>
		</div>
		<div style="text-align: center; padding: 0.75rem 1.5rem; background: #fef3c7; border-radius: 8px;">
			<div style="font-size: 1.5rem; font-weight: 700; color: #d97706;">{{.Stats.UnmatchedCount}}</div>
			<div style="color: #6b7280; font-size: 0.875rem;">Unmatched</div>
		</div>
		<div style="text-align: center; padding: 0.75rem 1.5rem; background: #e5e7eb; border-radius: 8px;">
			<div style="font-size: 1.5rem; font-weight: 700; color: #6b7280;">{{.Stats.IgnoredCount}}</div>
			<div style="color: #6b7280; font-size: 0.875rem;">Ignored</div>
		</div>
		<div style="text-align: center; padding: 0.75rem 1.5rem; background: #dbeafe; border-radius: 8px;">
			<div style="font-size: 1.5rem; font-weight: 700; color: #2563eb;">{{.Stats.CreatedCount}}</div>
			<div style="color: #6b7280; font-size: 0.875rem;">Created</div>
		</div>
	</div>
	<div style="margin-top: 1rem; display: flex; gap: 2rem; color: #6b7280; font-size: 0.875rem;">
		<div>Total Credits: <span style="color: #16a34a; font-weight: 600;">${{printf "%.2f" .Stats.TotalCredits}}</span></div>
		<div>Total Debits: <span style="color: #dc2626; font-weight: 600;">${{printf "%.2f" .Stats.TotalDebits}}</span></div>
	</div>
</div>
{{end}}

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
	<h2 style="margin: 0;">Transactions</h2>
	<div style="display: flex; gap: 0.25rem;">
		<button type="button" class="btn btn-small filter-btn active" data-filter="all">All</button>
		<button type="button" class="btn btn-small filter-btn" data-filter="unmatched">Unmatched</button>
		<button type="button" class="btn btn-small filter-btn" data-filter="matched">Matched</button>
		<button type="button" class="btn btn-small filter-btn" data-filter="created">Created</button>
		<button type="button" class="btn btn-small filter-btn" data-filter="ignored">Ignored</button>
	</div>
</div>
{{if .Transactions}}
<table id="transactions-table">
	<thead>
		<tr>
			<th>Date</th>
			<th>Description</th>
			<th>Type</th>
			<th class="money">Amount</th>
			<th>Status</th>
			<th>Match</th>
			<th class="actions">Actions</th>
		</tr>
	</thead>
	<tbody>
		{{$reconID := .Reconciliation.ID}}
		{{$expenses := .Expenses}}
		{{$vendors := .Vendors}}
		{{range .Transactions}}
		<tr data-status="{{.MatchStatus}}">
			<td>{{.PostingDate}}</td>
			<td>
				{{.Description}}
				{{if .CheckNumber}}<br><small style="color: #6b7280;">Check #{{.CheckNumber}}</small>{{end}}
				{{if .VendorHint}}<br><small style="color: #6b7280;">Vendor: {{.VendorHint}}</small>{{end}}
			</td>
			<td>
				<form action="/bank-statements/{{$reconID}}/update-type" method="POST" style="margin: 0;">
					<input type="hidden" name="transaction_id" value="{{.ID}}">
					<select name="transaction_type" onchange="this.form.submit()" style="font-size: 0.75rem; padding: 2px 4px; border: 1px solid #d1d5db; border-radius: 4px; background: #f9fafb;">
						<option value="deposit" {{if eq .TransactionType "deposit"}}selected{{end}}>deposit</option>
						<option value="ach" {{if eq .TransactionType "ach"}}selected{{end}}>ach</option>
						<option value="refund" {{if eq .TransactionType "refund"}}selected{{end}}>refund</option>
						<option value="check" {{if eq .TransactionType "check"}}selected{{end}}>check</option>
						<option value="debit" {{if eq .TransactionType "debit"}}selected{{end}}>debit</option>
						<option value="transfer" {{if eq .TransactionType "transfer"}}selected{{end}}>transfer</option>
						<option value="fee" {{if eq .TransactionType "fee"}}selected{{end}}>fee</option>
						<option value="other" {{if eq .TransactionType "other"}}selected{{end}}>other</option>
					</select>
				</form>
			</td>
			<td class="money">
				{{if lt .Amount 0.0}}
					<span style="color: #dc2626;">${{printf "%.2f" .Amount}}</span>
				{{else}}
					<span style="color: #16a34a;">+${{printf "%.2f" .Amount}}</span>
				{{end}}
			</td>
			<td>
				{{if eq .MatchStatus "matched"}}
					<span class="status status-paid">Matched</span>
				{{else if eq .MatchStatus "ignored"}}
					<span class="status" style="background: #e5e7eb; color: #6b7280;">Ignored</span>
				{{else if eq .MatchStatus "created"}}
					<span class="status" style="background: #dbeafe; color: #2563eb;">Created</span>
				{{else}}
					<span class="status status-unpaid">Unmatched</span>
				{{end}}
			</td>
			<td>
				{{if .MatchedExpenseID}}
					<small>{{.MatchedExpenseVendor}}<br>{{.MatchedExpenseDate}}</small>
					{{if .MatchConfidence}}
						<br><span style="font-size: 0.625rem; color: #9ca3af;">{{.MatchConfidence}}</span>
					{{end}}
				{{else if eq .MatchStatus "ignored"}}
					<small style="color: #6b7280;">{{.Notes}}</small>
				{{else}}
					<span style="color: #9ca3af;">-</span>
				{{end}}
			</td>
			<td class="actions">
				{{if eq .MatchStatus "unmatched"}}
					<button type="button" class="btn btn-secondary btn-small" onclick="openMatchModal({{.ID}}, '{{.Description}}', {{.Amount}})">Match</button>
					<button type="button" class="btn btn-secondary btn-small" onclick="openCreateModal({{.ID}}, '{{.Description}}', {{.Amount}}, '{{.PostingDate}}')">Create</button>
					<form action="/bank-statements/{{$reconID}}/ignore" method="POST" style="display: inline; margin: 0;">
						<input type="hidden" name="transaction_id" value="{{.ID}}">
						<button type="submit" class="btn btn-secondary btn-small">Ignore</button>
					</form>
				{{else if or (eq .MatchStatus "matched") (eq .MatchStatus "created")}}
					<form action="/bank-statements/{{$reconID}}/unmatch" method="POST" style="display: inline; margin: 0;">
						<input type="hidden" name="transaction_id" value="{{.ID}}">
						<button type="submit" class="btn btn-secondary btn-small">Unmatch</button>
					</form>
				{{else if eq .MatchStatus "ignored"}}
					<form action="/bank-statements/{{$reconID}}/unmatch" method="POST" style="display: inline; margin: 0;">
						<input type="hidden" name="transaction_id" value="{{.ID}}">
						<button type="submit" class="btn btn-secondary btn-small">Restore</button>
					</form>
				{{end}}
			</td>
		</tr>
		{{end}}
	</tbody>
</table>

<!-- Match Modal -->
<div id="match-modal" class="modal" style="display: none;">
	<div class="modal-content">
		<h3>Match Transaction</h3>
		<p id="match-modal-desc"></p>
		<form action="/bank-statements/{{.Reconciliation.ID}}/match" method="POST">
			<input type="hidden" name="transaction_id" id="match-txn-id">
			<div class="form-group">
				<label for="expense_id">Select Expense to Match</label>
				<select name="expense_id" id="expense_id" required>
					<option value="">-- Select Expense --</option>
					{{range .Expenses}}
					<option value="{{.ID}}">${{printf "%.2f" .Amount}} - {{.VendorName}} ({{.Date}})</option>
					{{end}}
				</select>
			</div>
			<div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
				<button type="button" class="btn btn-secondary" onclick="closeMatchModal()">Cancel</button>
				<button type="submit" class="btn btn-primary">Match</button>
			</div>
		</form>
	</div>
</div>

<!-- Create Expense Modal -->
<div id="create-modal" class="modal" style="display: none;">
	<div class="modal-content">
		<h3>Create Expense from Transaction</h3>
		<p id="create-modal-desc"></p>
		<form action="/bank-statements/{{.Reconciliation.ID}}/create-expense" method="POST">
			<input type="hidden" name="transaction_id" id="create-txn-id">
			<div class="form-group">
				<label for="vendor_id">Vendor</label>
				<select name="vendor_id" id="vendor_id" required>
					<option value="">-- Select Vendor --</option>
					{{range .Vendors}}
					<option value="{{.ID}}">{{.Name}}</option>
					{{end}}
				</select>
			</div>
			<div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
				<button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
				<button type="submit" class="btn btn-primary">Create Expense</button>
			</div>
		</form>
	</div>
</div>

<style>
.modal {
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background: rgba(0,0,0,0.5);
	display: flex;
	align-items: center;
	justify-content: center;
	z-index: 1000;
}
.modal-content {
	background: white;
	padding: 1.5rem;
	border-radius: 8px;
	min-width: 400px;
	max-width: 90%;
}
.modal-content h3 {
	margin-top: 0;
}
.filter-btn {
	background: #e5e7eb;
	color: #374151;
	border: none;
}
.filter-btn:hover {
	background: #d1d5db;
}
.filter-btn.active {
	background: #3b82f6;
	color: white;
}
</style>

<script>
function openMatchModal(txnId, desc, amount) {
	document.getElementById('match-txn-id').value = txnId;
	document.getElementById('match-modal-desc').textContent = desc + ' ($' + Math.abs(amount).toFixed(2) + ')';
	document.getElementById('match-modal').style.display = 'flex';
}

function closeMatchModal() {
	document.getElementById('match-modal').style.display = 'none';
}

function openCreateModal(txnId, desc, amount, date) {
	document.getElementById('create-txn-id').value = txnId;
	document.getElementById('create-modal-desc').textContent = desc + ' ($' + Math.abs(amount).toFixed(2) + ') - ' + date;
	document.getElementById('create-modal').style.display = 'flex';
}

function closeCreateModal() {
	document.getElementById('create-modal').style.display = 'none';
}

// Close modal on background click
document.getElementById('match-modal').addEventListener('click', function(e) {
	if (e.target === this) closeMatchModal();
});
document.getElementById('create-modal').addEventListener('click', function(e) {
	if (e.target === this) closeCreateModal();
});

// Transaction filtering
document.querySelectorAll('.filter-btn').forEach(function(btn) {
	btn.addEventListener('click', function() {
		var filter = this.dataset.filter;

		// Update active button
		document.querySelectorAll('.filter-btn').forEach(function(b) {
			b.classList.remove('active');
		});
		this.classList.add('active');

		// Filter rows
		document.querySelectorAll('#transactions-table tbody tr').forEach(function(row) {
			if (filter === 'all' || row.dataset.status === filter) {
				row.style.display = '';
			} else {
				row.style.display = 'none';
			}
		});
	});
});
</script>
{{else}}
<p class="empty-state">No transactions found for this reconciliation.</p>
{{end}}

{{template "footer" .}}
